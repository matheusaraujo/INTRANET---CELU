---------------------------------------
-- INTRANET CELU
-- \App_Data\Procedures\BemEstar\TBL_PERSONA_NON_GRATA.SQL
-- # 2012-03-01 - Criação
-- Matheus Araújo
---------------------------------------

-------------------------------------------
-- PROCEDURE LOAD_LIST_PERSONA_NON_GRATA --
-------------------------------------------

CREATE PROCEDURE LOAD_LIST_PERSONA_NON_GRATA
(
    @P_LOAD_ALL BIT
)
AS
BEGIN
    IF @P_LOAD_ALL = 1
    BEGIN
        SELECT
            TBL_PERSONA_NON_GRATA.COD_PERSONA_NON_GRATA,
            CONVERT(VARCHAR(10), TBL_PERSONA_NON_GRATA.DT_DATA_ENTRADA, 103) AS DT_DATA_ENTRADA,
            CONVERT(VARCHAR(10), TBL_PERSONA_NON_GRATA.DT_DATA_SAIDA, 103) AS DT_DATA_SAIDA,
            TBL_PERSONA_NON_GRATA.CHR_QUARTO,
            TBL_PERSONA_NON_GRATA.CHR_NOME,
            TBL_PERSONA_NON_GRATA.CHR_PERIODO_ABERTO,
            TBL_PERSONA_NON_GRATA.FLT_DEBITO,
            TBL_PERSONA_NON_GRATA.CHR_OBSERVACAO,
            (CASE TBL_PERSONA_NON_GRATA.BLN_EM_ABERTO WHEN 1 THEN 'SIM' ELSE 'NÃO' END) AS CHR_EM_ABERTO
        FROM
            TBL_PERSONA_NON_GRATA
        ORDER BY
            TBL_PERSONA_NON_GRATA.CHR_NOME
    END
    ELSE
    BEGIN
        SELECT
            TBL_PERSONA_NON_GRATA.COD_PERSONA_NON_GRATA,
            CONVERT(VARCHAR(10), TBL_PERSONA_NON_GRATA.DT_DATA_ENTRADA, 103) AS DT_DATA_ENTRADA,
            CONVERT(VARCHAR(10), TBL_PERSONA_NON_GRATA.DT_DATA_SAIDA, 103) AS DT_DATA_SAIDA,
            TBL_PERSONA_NON_GRATA.CHR_QUARTO,
            TBL_PERSONA_NON_GRATA.CHR_NOME,
            TBL_PERSONA_NON_GRATA.CHR_PERIODO_ABERTO,
            TBL_PERSONA_NON_GRATA.FLT_DEBITO,
            TBL_PERSONA_NON_GRATA.CHR_OBSERVACAO,
            (CASE TBL_PERSONA_NON_GRATA.BLN_EM_ABERTO WHEN 1 THEN 'SIM' ELSE 'NÃO' END) AS CHR_EM_ABERTO
        FROM
            TBL_PERSONA_NON_GRATA
        WHERE
            TBL_PERSONA_NON_GRATA.BLN_EM_ABERTO = 1
        ORDER BY
            TBL_PERSONA_NON_GRATA.CHR_NOME
    END
END

------------------------------------------
-- PROCEDURE LOAD_REG_PERSONA_NON_GRATA --
------------------------------------------

CREATE PROCEDURE LOAD_REG_PERSONA_NON_GRATA
(
    @P_COD_PERSONA_NON_GRATA INT
)
AS
BEGIN
        SELECT
            TBL_PERSONA_NON_GRATA.COD_PERSONA_NON_GRATA,
            TBL_PERSONA_NON_GRATA.DT_DATA_ENTRADA,
            CONVERT(VARCHAR(10), TBL_PERSONA_NON_GRATA.DT_DATA_ENTRADA, 103) AS CHR_DATA_ENTRADA,
            TBL_PERSONA_NON_GRATA.DT_DATA_SAIDA,
            CONVERT(VARCHAR(10), TBL_PERSONA_NON_GRATA.DT_DATA_SAIDA, 103) AS CHR_DATA_SAIDA,
            TBL_PERSONA_NON_GRATA.CHR_QUARTO,
            TBL_PERSONA_NON_GRATA.CHR_NOME,
            TBL_PERSONA_NON_GRATA.CHR_PERIODO_ABERTO,
            TBL_PERSONA_NON_GRATA.FLT_DEBITO,
            TBL_PERSONA_NON_GRATA.CHR_OBSERVACAO,
            TBL_PERSONA_NON_GRATA.BLN_EM_ABERTO
        FROM
            TBL_PERSONA_NON_GRATA
        WHERE
            TBL_PERSONA_NON_GRATA.COD_PERSONA_NON_GRATA = @P_COD_PERSONA_NON_GRATA
        ORDER BY
            TBL_PERSONA_NON_GRATA.CHR_NOME
END

----------------------------------------
-- PROCEDURE INSERT_PERSONA_NON_GRATA --
----------------------------------------

CREATE PROCEDURE INSERT_PERSONA_NON_GRATA
(
    @P_COD_PERSONA_NON_GRATA INT,
    @P_DT_DATA_ENTRADA SMALLDATETIME,
    @P_DT_DATA_SAIDA SMALLDATETIME,
    @P_CHR_QUARTO VARCHAR(16),
    @P_CHR_NOME VARCHAR(256),
    @P_CHR_PERIODO_ABERTO VARCHAR(128),
    @P_FLT_DEBITO NUMERIC(10,2),
    @P_CHR_OBSERVACAO VARCHAR(1024),
    @P_BLN_EM_ABERTO BIT
)
AS
BEGIN
    IF
    (
        SELECT
            COUNT(*)
        FROM
            TBL_PERSONA_NON_GRATA
        WHERE
            TBL_PERSONA_NON_GRATA.COD_PERSONA_NON_GRATA = @P_COD_PERSONA_NON_GRATA
    ) > 0
    BEGIN
        UPDATE
            TBL_PERSONA_NON_GRATA
        SET            
            TBL_PERSONA_NON_GRATA.DT_DATA_ENTRADA = @P_DT_DATA_ENTRADA,
            TBL_PERSONA_NON_GRATA.DT_DATA_SAIDA = @P_DT_DATA_SAIDA,
            TBL_PERSONA_NON_GRATA.CHR_QUARTO = @P_CHR_QUARTO,
            TBL_PERSONA_NON_GRATA.CHR_NOME = @P_CHR_NOME,
            TBL_PERSONA_NON_GRATA.CHR_PERIODO_ABERTO = @P_CHR_PERIODO_ABERTO,
            TBL_PERSONA_NON_GRATA.FLT_DEBITO = @P_FLT_DEBITO,
            TBL_PERSONA_NON_GRATA.CHR_OBSERVACAO = @P_CHR_OBSERVACAO,
            TBL_PERSONA_NON_GRATA.BLN_EM_ABERTO = @P_BLN_EM_ABERTO
        WHERE
            TBL_PERSONA_NON_GRATA.COD_PERSONA_NON_GRATA = @P_COD_PERSONA_NON_GRATA
    END
    ELSE
    BEGIN
        INSERT INTO TBL_PERSONA_NON_GRATA
        (        
            TBL_PERSONA_NON_GRATA.DT_DATA_ENTRADA,
            TBL_PERSONA_NON_GRATA.DT_DATA_SAIDA,
            TBL_PERSONA_NON_GRATA.CHR_QUARTO,
            TBL_PERSONA_NON_GRATA.CHR_NOME,
            TBL_PERSONA_NON_GRATA.CHR_PERIODO_ABERTO,
            TBL_PERSONA_NON_GRATA.FLT_DEBITO,
            TBL_PERSONA_NON_GRATA.CHR_OBSERVACAO,
            TBL_PERSONA_NON_GRATA.BLN_EM_ABERTO
        )
        VALUES
        (
            @P_DT_DATA_ENTRADA,
            @P_DT_DATA_SAIDA,
            @P_CHR_QUARTO,
            @P_CHR_NOME,
            @P_CHR_PERIODO_ABERTO,
            @P_FLT_DEBITO,
            @P_CHR_OBSERVACAO,
            @P_BLN_EM_ABERTO
        )
    END
END

----------------------------------------
-- PROCEDURE DELETE_PERSONA_NON_GRATA --
----------------------------------------

CREATE PROCEDURE DELETE_PERSONA_NON_GRATA
(
    @P_COD_PERSONA_NON_GRATA INT
)
AS
BEGIN
    
    DELETE
		TBL_PERSONA_NON_GRATA
	WHERE
		TBL_PERSONA_NON_GRATA.COD_PERSONA_NON_GRATA = @P_COD_PERSONA_NON_GRATA
	
	-- MENSAGEM DE RETORNO	
	SELECT '' AS P_CHR_MSG_ERRO
	
END
