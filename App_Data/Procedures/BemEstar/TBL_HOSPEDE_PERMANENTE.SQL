---------------------------------------
-- INTRANET CELU
-- \App_Data\Procedures\BemEstar\TBL_HOSPEDE_PERMANENTE.SQL
-- # 2012-03-01 - Criação
-- Matheus Araújo
---------------------------------------

--------------------------------------------
-- PROCEDURE LOAD_LIST_HOSPEDE_PERMANENTE --
--------------------------------------------

CREATE PROCEDURE LOAD_LIST_HOSPEDE_PERMANENTE
(
    @P_LOAD_ALL BIT
)
AS
BEGIN
    IF @P_LOAD_ALL = 1
    BEGIN
        SELECT
            TBL_HOSPEDE_PERMANENTE.COD_HOSPEDE_PERMANENTE,
            TBL_HOSPEDE_PERMANENTE.COD_QUARTO,
            TBL_QUARTO.CHR_DESC_QUARTO,
            TBL_HOSPEDE_PERMANENTE.CHR_NOME,
            TBL_HOSPEDE_PERMANENTE.CHR_RG,
            TBL_HOSPEDE_PERMANENTE.CHR_CPF,
            TBL_HOSPEDE_PERMANENTE.COD_CIDADE_ORIGEM,
            (TBL_CIDADE.CHR_CIDADE + ' - ' + TBL_CIDADE.CHR_ESTADO) AS CHR_CIDADE_ORIGEM,
            TBL_HOSPEDE_PERMANENTE.CHR_CURSO,
            TBL_HOSPEDE_PERMANENTE.CHR_RECEPCAO,
            TBL_HOSPEDE_PERMANENTE.INT_DIA_VENCIMENTO,
            CONVERT(VARCHAR(10), TBL_HOSPEDE_PERMANENTE.DT_DATA_INGRESSO, 103) AS DT_DATA_INGRESSO,
            TBL_HOSPEDE_PERMANENTE.BLN_ATIVO,
            (
                CASE TBL_HOSPEDE_PERMANENTE.BLN_ATIVO
                WHEN 1 THEN 'Sim'
                ELSE 'Não' END
            ) AS CHR_ATIVO
        FROM
            TBL_HOSPEDE_PERMANENTE
            LEFT JOIN TBL_QUARTO
                ON TBL_HOSPEDE_PERMANENTE.COD_QUARTO = TBL_QUARTO.COD_QUARTO
            LEFT JOIN TBL_CIDADE
                ON TBL_HOSPEDE_PERMANENTE.COD_CIDADE_ORIGEM = TBL_CIDADE.COD_CIDADE
        ORDER BY
            TBL_HOSPEDE_PERMANENTE.CHR_NOME    
    END
    ELSE
    BEGIN
        SELECT
            TBL_HOSPEDE_PERMANENTE.COD_HOSPEDE_PERMANENTE,
            TBL_HOSPEDE_PERMANENTE.COD_QUARTO,
            TBL_QUARTO.CHR_DESC_QUARTO,
            TBL_HOSPEDE_PERMANENTE.CHR_NOME,
            TBL_HOSPEDE_PERMANENTE.CHR_RG,
            TBL_HOSPEDE_PERMANENTE.CHR_CPF,
            TBL_HOSPEDE_PERMANENTE.COD_CIDADE_ORIGEM,
            (TBL_CIDADE.CHR_CIDADE + ' - ' + TBL_CIDADE.CHR_ESTADO) AS CHR_CIDADE_ORIGEM,
            TBL_HOSPEDE_PERMANENTE.CHR_CURSO,
            TBL_HOSPEDE_PERMANENTE.CHR_RECEPCAO,
            TBL_HOSPEDE_PERMANENTE.INT_DIA_VENCIMENTO,
            CONVERT(VARCHAR(10), TBL_HOSPEDE_PERMANENTE.DT_DATA_INGRESSO, 103) AS DT_DATA_INGRESSO,
            TBL_HOSPEDE_PERMANENTE.BLN_ATIVO,
            (
                CASE TBL_HOSPEDE_PERMANENTE.BLN_ATIVO
                WHEN 1 THEN 'Sim'
                ELSE 'Não' END
            ) AS CHR_ATIVO
        FROM
            TBL_HOSPEDE_PERMANENTE
            LEFT JOIN TBL_QUARTO
                ON TBL_HOSPEDE_PERMANENTE.COD_QUARTO = TBL_QUARTO.COD_QUARTO
            LEFT JOIN TBL_CIDADE
                ON TBL_HOSPEDE_PERMANENTE.COD_CIDADE_ORIGEM = TBL_CIDADE.COD_CIDADE
        WHERE
            TBL_HOSPEDE_PERMANENTE.BLN_ATIVO = 1
        ORDER BY
            TBL_HOSPEDE_PERMANENTE.CHR_NOME    
    END
END

-------------------------------------------
-- PROCEDURE LOAD_REG_HOSPEDE_PERMANENTE --
-------------------------------------------

CREATE PROCEDURE LOAD_REG_HOSPEDE_PERMANENTE
(
    @P_COD_HOSPEDE_PERMANENTE INT
)
AS
BEGIN
     SELECT
        TBL_HOSPEDE_PERMANENTE.COD_HOSPEDE_PERMANENTE,
        TBL_HOSPEDE_PERMANENTE.COD_QUARTO,
        TBL_QUARTO.CHR_DESC_QUARTO,
        TBL_HOSPEDE_PERMANENTE.CHR_NOME,
        TBL_HOSPEDE_PERMANENTE.CHR_RG,
        TBL_HOSPEDE_PERMANENTE.CHR_CPF,
        TBL_HOSPEDE_PERMANENTE.COD_CIDADE_ORIGEM,
        (TBL_CIDADE.CHR_CIDADE + ' - ' + TBL_CIDADE.CHR_ESTADO) AS CHR_CIDADE_ORIGEM,
        TBL_HOSPEDE_PERMANENTE.CHR_CURSO,
        TBL_HOSPEDE_PERMANENTE.CHR_RECEPCAO,
        TBL_HOSPEDE_PERMANENTE.INT_DIA_VENCIMENTO,
        TBL_HOSPEDE_PERMANENTE.DT_DATA_INGRESSO,
        CONVERT(VARCHAR(10), TBL_HOSPEDE_PERMANENTE.DT_DATA_INGRESSO, 103) AS CHR_DATA_INGRESSO,
        TBL_HOSPEDE_PERMANENTE.BLN_ATIVO
    FROM
        TBL_HOSPEDE_PERMANENTE
        LEFT JOIN TBL_QUARTO
            ON TBL_HOSPEDE_PERMANENTE.COD_QUARTO = TBL_QUARTO.COD_QUARTO
        LEFT JOIN TBL_CIDADE
            ON TBL_HOSPEDE_PERMANENTE.COD_CIDADE_ORIGEM = TBL_CIDADE.COD_CIDADE
    WHERE
        TBL_HOSPEDE_PERMANENTE.COD_HOSPEDE_PERMANENTE = @P_COD_HOSPEDE_PERMANENTE
END

----------------------------------------
-- PROCEDURE INSERT_HOSPEDE_PERMANENTE --
----------------------------------------

CREATE PROCEDURE INSERT_HOSPEDE_PERMANENTE
(
    @P_COD_HOSPEDE_PERMANENTE INT,
    @P_COD_QUARTO INT,
    @P_CHR_NOME VARCHAR(256),
    @P_CHR_RG VARCHAR(16),
    @P_CHR_CPF VARCHAR(16),
    @P_COD_CIDADE_ORIGEM INT,    
    @P_CHR_CURSO VARCHAR(256),
    @P_CHR_RECEPCAO VARCHAR(256),
    @P_INT_DIA_VENCIMENTO INT,
    @P_DT_DATA_INGRESSO SMALLDATETIME,
    @P_BLN_ATIVO BIT
)
AS
BEGIN
    IF
    (
        SELECT
            COUNT(*)
        FROM
            TBL_HOSPEDE_PERMANENTE
        WHERE
            TBL_HOSPEDE_PERMANENTE.COD_HOSPEDE_PERMANENTE = @P_COD_HOSPEDE_PERMANENTE
    ) > 0
    BEGIN
        UPDATE
            TBL_HOSPEDE_PERMANENTE
        SET 
            TBL_HOSPEDE_PERMANENTE.COD_QUARTO = @P_COD_QUARTO,
            TBL_HOSPEDE_PERMANENTE.CHR_NOME = @P_CHR_NOME,
            TBL_HOSPEDE_PERMANENTE.CHR_RG = @P_CHR_RG,
            TBL_HOSPEDE_PERMANENTE.CHR_CPF = @P_CHR_CPF,
            TBL_HOSPEDE_PERMANENTE.COD_CIDADE_ORIGEM = @P_COD_CIDADE_ORIGEM,
            TBL_HOSPEDE_PERMANENTE.CHR_CURSO = @P_CHR_CURSO,
            TBL_HOSPEDE_PERMANENTE.CHR_RECEPCAO = @P_CHR_RECEPCAO,
            TBL_HOSPEDE_PERMANENTE.INT_DIA_VENCIMENTO = @P_INT_DIA_VENCIMENTO,
            TBL_HOSPEDE_PERMANENTE.DT_DATA_INGRESSO = @P_DT_DATA_INGRESSO,
            TBL_HOSPEDE_PERMANENTE.BLN_ATIVO = @P_BLN_ATIVO
        WHERE
            TBL_HOSPEDE_PERMANENTE.COD_HOSPEDE_PERMANENTE = @P_COD_HOSPEDE_PERMANENTE
    END
    ELSE
    BEGIN
        INSERT INTO TBL_HOSPEDE_PERMANENTE
        (       
            
            TBL_HOSPEDE_PERMANENTE.COD_QUARTO,
            TBL_HOSPEDE_PERMANENTE.CHR_NOME,
            TBL_HOSPEDE_PERMANENTE.CHR_RG,
            TBL_HOSPEDE_PERMANENTE.CHR_CPF,
            TBL_HOSPEDE_PERMANENTE.COD_CIDADE_ORIGEM,    
            TBL_HOSPEDE_PERMANENTE.CHR_CURSO,
            TBL_HOSPEDE_PERMANENTE.CHR_RECEPCAO,
            TBL_HOSPEDE_PERMANENTE.INT_DIA_VENCIMENTO,
            TBL_HOSPEDE_PERMANENTE.DT_DATA_INGRESSO,
            TBL_HOSPEDE_PERMANENTE.BLN_ATIVO
        )
        VALUES
        (
            @P_COD_QUARTO,
            @P_CHR_NOME,
            @P_CHR_RG,
            @P_CHR_CPF,
            @P_COD_CIDADE_ORIGEM,    
            @P_CHR_CURSO,
            @P_CHR_RECEPCAO,
            @P_INT_DIA_VENCIMENTO,
            @P_DT_DATA_INGRESSO,
            @P_BLN_ATIVO
        )
    END
END

----------------------------------------
-- PROCEDURE DELETE_HOSPEDE_PERMANENTE --
----------------------------------------

CREATE PROCEDURE DELETE_HOSPEDE_PERMANENTE
(
    @P_COD_HOSPEDE_PERMANENTE INT
)
AS
BEGIN
    
    DELETE
		TBL_HOSPEDE_PERMANENTE
	WHERE
		TBL_HOSPEDE_PERMANENTE.COD_HOSPEDE_PERMANENTE = @P_COD_HOSPEDE_PERMANENTE
	
	-- MENSAGEM DE RETORNO	
	SELECT '' AS P_CHR_MSG_ERRO
	
END
