---------------------------------------
-- INTRANET CELU
-- \App_Data\Procedures\BemEstar\TBL_RESERVA.SQL
-- # 2012-03-21 - Criação
-- Matheus Araújo
---------------------------------------
----------------------------------
-- PROCEUDURE LOAD_LIST_RESERVA --
----------------------------------

CREATE PROCEDURE LOAD_LIST_RESERVA
(
    @P_COD_ESPACO_RESERVA INT
)
AS
BEGIN
	SELECT
	    TBL_RESERVA.COD_RESERVA,
	    TBL_RESERVA.COD_ESPACO_RESERVA,
	    TBL_ESPACO_RESERVA.CHR_NOME_ESPACO_RESERVA,
	    TBL_RESERVA.COD_STATUS_RESERVA,
	    TBL_STATUS_RESERVA.CHR_STATUS_RESERVA,
	    TBL_RESERVA.DT_DATA_HORA_INICIAL,
	    (
	        CONVERT(VARCHAR(10), TBL_RESERVA.DT_DATA_HORA_INICIAL, 103) + ' ' +
	        CONVERT(VARCHAR(5), TBL_RESERVA.DT_DATA_HORA_INICIAL, 108)
	    ) AS CHR_DATA_HORA_INICIAL,
	    TBL_RESERVA.DT_DATA_HORA_FINAL,
	    (
	        CONVERT(VARCHAR(10), TBL_RESERVA.DT_DATA_HORA_FINAL, 103) + ' ' +
	        CONVERT(VARCHAR(5), TBL_RESERVA.DT_DATA_HORA_FINAL, 108)
	    ) AS CHR_DATA_HORA_FINAL,
	    TBL_RESERVA.CHR_EVENTO,
	    TBL_RESERVA.INT_QUANTIDADE,
        TBL_RESERVA.CHR_RESPONSAVEL,
        TBL_RESERVA.CHR_CONTATO,
        TBL_RESERVA.CHR_ORIGEM,
        TBL_RESERVA.CHR_OBSERVACAO,
        TBL_RESERVA.BLN_RESERVA_EXCLUSIVA,
        (
            CASE TBL_RESERVA.BLN_RESERVA_EXCLUSIVA
            WHEN 1 THEN 'Sim'
            ELSE 'Não' END
        ) AS CHR_RESERVA_EXCLUSIVA,
        TBL_RESERVA.DT_DATA_DA_RESERVA,
        TBL_RESERVA.CHR_RESPONSAVEL_RESERVA
    FROM
        TBL_RESERVA
        LEFT JOIN TBL_ESPACO_RESERVA
            ON TBL_RESERVA.COD_ESPACO_RESERVA = TBL_ESPACO_RESERVA.COD_ESPACO_RESERVA
        LEFT JOIN TBL_STATUS_RESERVA
            ON TBL_STATUS_RESERVA.COD_STATUS_RESERVA = TBL_STATUS_RESERVA.COD_STATUS_RESERVA
    WHERE
        TBL_RESERVA.COD_ESPACO_RESERVA = @P_COD_ESPACO_RESERVA
    ORDER BY
        TBL_RESERVA.DT_DATA_HORA_INICIAL,
        TBL_RESERVA.CHR_EVENTO	    
END

--------------------------------
-- PROCEDURE LOAD_REG_RESERVA --
--------------------------------

CREATE PROCEDURE LOAD_REG_RESERVA
(
    @P_COD_RESERVA INT
)
AS
BEGIN
   	SELECT
	    TBL_RESERVA.COD_RESERVA,
	    TBL_RESERVA.COD_ESPACO_RESERVA,
	    TBL_ESPACO_RESERVA.CHR_NOME_ESPACO_RESERVA,
	    TBL_RESERVA.COD_STATUS_RESERVA,
	    TBL_STATUS_RESERVA.CHR_STATUS_RESERVA,
	    TBL_RESERVA.DT_DATA_HORA_INICIAL,
	    (
	        CONVERT(VARCHAR(10), TBL_RESERVA.DT_DATA_HORA_INICIAL, 103) + ' ' +
	        CONVERT(VARCHAR(5), TBL_RESERVA.DT_DATA_HORA_INICIAL, 108)
	    ) AS CHR_DATA_HORA_INICIAL,
	    TBL_RESERVA.DT_DATA_HORA_FINAL,
	    (
	        CONVERT(VARCHAR(10), TBL_RESERVA.DT_DATA_HORA_FINAL, 103) + ' ' +
	        CONVERT(VARCHAR(5), TBL_RESERVA.DT_DATA_HORA_FINAL, 108)
	    ) AS CHR_DATA_HORA_FINAL,
	    TBL_RESERVA.CHR_EVENTO,
	    TBL_RESERVA.INT_QUANTIDADE,
        TBL_RESERVA.CHR_RESPONSAVEL,
        TBL_RESERVA.CHR_CONTATO,
        TBL_RESERVA.CHR_ORIGEM,
        TBL_RESERVA.CHR_OBSERVACAO,
        TBL_RESERVA.BLN_RESERVA_EXCLUSIVA,
        (
            CASE TBL_RESERVA.BLN_RESERVA_EXCLUSIVA
            WHEN 1 THEN 'Sim'
            ELSE 'Não' END
        ) AS CHR_RESERVA_EXCLUSIVA,
        TBL_RESERVA.DT_DATA_DA_RESERVA,
        TBL_RESERVA.CHR_RESPONSAVEL_RESERVA
    FROM
        TBL_RESERVA
        LEFT JOIN TBL_ESPACO_RESERVA
            ON TBL_RESERVA.COD_ESPACO_RESERVA = TBL_ESPACO_RESERVA.COD_ESPACO_RESERVA
        LEFT JOIN TBL_STATUS_RESERVA
            ON TBL_STATUS_RESERVA.COD_STATUS_RESERVA = TBL_STATUS_RESERVA.COD_STATUS_RESERVA
    WHERE
        TBL_RESERVA.COD_RESERVA = @P_COD_RESERVA
END

-------------------------------------
-- PROCEDURE VERIFY_INSERT_RESERVA --
-------------------------------------

CREATE PROCEDURE VERIFY_INSERT_RESERVA
(
    @P_COD_RESERVA INT,
    @P_COD_ESPACO_RESERVA INT,
    @P_COD_STATUS_RESERVA INT,
    @P_DT_DATA_HORA_INICIAL SMALLDATETIME,
    @P_DT_DATA_HORA_FINAL SMALLDATETIME,
    @P_CHR_EVENTO VARCHAR(256),
    @P_INT_QUANTIDADE INT,
    @P_CHR_RESPONSAVEL VARCHAR(256),
    @P_CHR_CONTATO VARCHAR(256),
    @P_CHR_ORIGEM VARCHAR(256),
    @P_CHR_OBSERVACAO VARCHAR(1024),
    @P_BLN_RESERVA_EXCLUSIVA BIT,
    @P_DT_DATA_DA_RESERVA SMALLDATETIME,
    @P_CHR_RESPONSAVEL_RESERVA VARCHAR(256)
)
AS
BEGIN
    

    IF
    (
        SELECT
            COUNT(*)
        FROM
            TBL_RESERVA
        WHERE
            TBL_RESERVA.COD_ESPACO_RESERVA = @P_COD_ESPACO_RESERVA AND
            TBL_RESERVA.BLN_RESERVA_EXCLUSIVA = 1 AND
            TBL_RESERVA.COD_RESERVA <> ISNULL(@P_COD_RESERVA,-1) AND            
            (
                @P_DT_DATA_HORA_INICIAL BETWEEN TBL_RESERVA.DT_DATA_HORA_INICIAL AND TBL_RESERVA.DT_DATA_HORA_FINAL OR
                @P_DT_DATA_HORA_FINAL BETWEEN TBL_RESERVA.DT_DATA_HORA_INICIAL AND TBL_RESERVA.DT_DATA_HORA_FINAL
            )
    ) > 0    
    BEGIN
        SELECT 'Existe uma reserva no período informado!' AS P_CHR_MSG_ERRO
    END
    ELSE
    BEGIN
        SELECT '' AS P_CHR_MSG_ERRO
    END

END

------------------------------
-- PROCEDURE INSERT_RESERVA --
------------------------------

CREATE PROCEDURE INSERT_RESERVA
(
    @P_COD_RESERVA INT,
    @P_COD_ESPACO_RESERVA INT,
    @P_COD_STATUS_RESERVA INT,
    @P_DT_DATA_HORA_INICIAL SMALLDATETIME,
    @P_DT_DATA_HORA_FINAL SMALLDATETIME,
    @P_CHR_EVENTO VARCHAR(256),
    @P_INT_QUANTIDADE INT,
    @P_CHR_RESPONSAVEL VARCHAR(256),
    @P_CHR_CONTATO VARCHAR(256),
    @P_CHR_ORIGEM VARCHAR(256),
    @P_CHR_OBSERVACAO VARCHAR(1024),
    @P_BLN_RESERVA_EXCLUSIVA BIT,
    @P_DT_DATA_DA_RESERVA SMALLDATETIME,
    @P_CHR_RESPONSAVEL_RESERVA VARCHAR(256)
)
AS
BEGIN
    IF 
    (
        SELECT
            COUNT(*)
        FROM
            TBL_RESERVA
        WHERE
            TBL_RESERVA.COD_RESERVA = @P_COD_RESERVA            
    ) 
    > 0
    BEGIN
        UPDATE
            TBL_RESERVA
        SET            
            TBL_RESERVA.COD_ESPACO_RESERVA = @P_COD_ESPACO_RESERVA,
            TBL_RESERVA.COD_STATUS_RESERVA = @P_COD_STATUS_RESERVA,
            TBL_RESERVA.DT_DATA_HORA_INICIAL = @P_DT_DATA_HORA_INICIAL,
            TBL_RESERVA.DT_DATA_HORA_FINAL = @P_DT_DATA_HORA_FINAL,
            TBL_RESERVA.CHR_EVENTO = @P_CHR_EVENTO,
            TBL_RESERVA.INT_QUANTIDADE = @P_INT_QUANTIDADE,
            TBL_RESERVA.CHR_RESPONSAVEL = @P_CHR_RESPONSAVEL,
            TBL_RESERVA.CHR_CONTATO = @P_CHR_CONTATO,
            TBL_RESERVA.CHR_ORIGEM = @P_CHR_ORIGEM,
            TBL_RESERVA.CHR_OBSERVACAO = @P_CHR_OBSERVACAO,
            TBL_RESERVA.BLN_RESERVA_EXCLUSIVA = @P_BLN_RESERVA_EXCLUSIVA,
            TBL_RESERVA.DT_DATA_DA_RESERVA = @P_DT_DATA_DA_RESERVA,
            TBL_RESERVA.CHR_RESPONSAVEL_RESERVA = @P_CHR_RESPONSAVEL_RESERVA
        WHERE
            TBL_RESERVA.COD_RESERVA = @P_COD_RESERVA
    END
    ELSE
    BEGIN
        INSERT INTO TBL_RESERVA
        (
            TBL_RESERVA.COD_ESPACO_RESERVA,
            TBL_RESERVA.COD_STATUS_RESERVA,
            TBL_RESERVA.DT_DATA_HORA_INICIAL,
            TBL_RESERVA.DT_DATA_HORA_FINAL,
            TBL_RESERVA.CHR_EVENTO,
            TBL_RESERVA.INT_QUANTIDADE,
            TBL_RESERVA.CHR_RESPONSAVEL,
            TBL_RESERVA.CHR_CONTATO,
            TBL_RESERVA.CHR_ORIGEM,
            TBL_RESERVA.CHR_OBSERVACAO,
            TBL_RESERVA.BLN_RESERVA_EXCLUSIVA,
            TBL_RESERVA.DT_DATA_DA_RESERVA,
            TBL_RESERVA.CHR_RESPONSAVEL_RESERVA
        )
        VALUES
        (
            @P_COD_ESPACO_RESERVA,
            @P_COD_STATUS_RESERVA,
            @P_DT_DATA_HORA_INICIAL,
            @P_DT_DATA_HORA_FINAL,
            @P_CHR_EVENTO,
            @P_INT_QUANTIDADE,
            @P_CHR_RESPONSAVEL,
            @P_CHR_CONTATO,
            @P_CHR_ORIGEM,
            @P_CHR_OBSERVACAO,
            @P_BLN_RESERVA_EXCLUSIVA,
            @P_DT_DATA_DA_RESERVA,
            @P_CHR_RESPONSAVEL_RESERVA   
        )
    END
END

------------------------------
-- PROCEDURE DELETE_RESERVA --
------------------------------

CREATE PROCEDURE DELETE_RESERVA
(
    @P_COD_RESERVA INT
)
AS
BEGIN
 
    SELECT '' AS P_CHR_MSG_ERRO
    
    DELETE
        TBL_RESERVA
    WHERE
        TBL_RESERVA.COD_STATUS_RESERVA = @P_COD_RESERVA
 
END
