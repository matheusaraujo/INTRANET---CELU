--------------------------------------
-- INTRANET CELU
-- \App_Data\Procedures\BemEstar\TBL_HOSPEDE_PERMANENTE_PAGAMENTO.SQL
-- # 2012-03-16 - Criação
-- Matheus Araújo
---------------------------------------

----------------------------------------------------------
-- PROCEDURE VERIFY_INSERT_HOSPEDE_PERMANENTE_PAGAMENTO --
----------------------------------------------------------

CREATE PROCEDURE VERIFY_INSERT_HOSPEDE_PERMANENTE_PAGAMENTO
(
    @P_COD_HOSPEDE_PERMANENTE INT,
    @P_INT_MES INT,
    @P_INT_ANO INT,
    @P_FLT_VALOR NUMERIC(10,2),
    @P_DT_DATA_PAGAMENTO SMALLDATETIME,
    @P_CHR_OBSERVACAO VARCHAR(1024)
)
AS
BEGIN
    IF
    ((
        SELECT
            COUNT(*)
        FROM
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO
        WHERE
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.INT_MES = @P_INT_MES AND
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.INT_ANO = @P_INT_ANO AND
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.COD_HOSPEDE_PERMANENTE = @P_COD_HOSPEDE_PERMANENTE
    ) > 0)    
    BEGIN
        SELECT 'O pagamento já foi registrado!' AS P_CHR_MSG_ERRO
    END
    ELSE
    BEGIN
        SELECT '' AS P_CHR_MSG_ERRO
    END
END

---------------------------------------------------
-- PROCEDURE INSERT_HOSPEDE_PERMANENTE_PAGAMENTO --
---------------------------------------------------

CREATE PROCEDURE INSERT_HOSPEDE_PERMANENTE_PAGAMENTO
(    
    @P_COD_HOSPEDE_PERMANENTE INT,
    @P_INT_MES INT,
    @P_INT_ANO INT,
    @P_FLT_VALOR NUMERIC(10,2),
    @P_DT_DATA_PAGAMENTO SMALLDATETIME,
    @P_CHR_OBSERVACAO VARCHAR(1024)
)
AS
BEGIN
    INSERT INTO TBL_HOSPEDE_PERMANENTE_PAGAMENTO
    (
        TBL_HOSPEDE_PERMANENTE.COD_HOSPEDE_PERMANENTE,
        TBL_HOSPEDE_PERMANENTE.INT_MES,
        TBL_HOSPEDE_PERMANENTE.INT_ANO,
        TBL_HOSPEDE_PERMANENTE.FLT_VALOR,
        TBL_HOSPEDE_PERMANENTE.DT_DATA_PAGAMENTO,
        TBL_HOSPEDE_PERMANENTE.CHR_OBSERVACAO
    )
    VALUES
    (
        @P_COD_HOSPEDE_PERMANENTE,
        @P_INT_MES,
        @P_INT_ANO,
        @P_FLT_VALOR,
        @P_DT_DATA_PAGAMENTO,
        @P_CHR_OBSERVACAO
    )    
END

----------------------------------------------------------------
-- PROCEDURE LOAD_LIST_HOSPEDE_PERMANENTE_PAGAMENTO_MES_ATUAL --
----------------------------------------------------------------

CREATE PROCEDURE LOAD_LIST_HOSPEDE_PERMANENTE_PAGAMENTO_MES_ATUAL
AS
BEGIN
    SELECT
        TBL_HOSPEDE_PERMANENTE.CHR_NOME,
        (
            CASE (
                SELECT
                    COUNT (*)
                FROM
                    TBL_HOSPEDE_PERMANENTE_PAGAMENTO
                WHERE
                    TBL_HOSPEDE_PERMANENTE_PAGAMENTO.COD_HOSPEDE_PERMANENTE = TBL_HOSPEDE_PERMANENTE.COD_HOSPEDE_PERMANENTE AND
                    TBL_HOSPEDE_PERMANENTE_PAGAMENTO.INT_MES = DATEPART ( month, GETDATE()) AND
                    TBL_HOSPEDE_PERMANENTE_PAGAMENTO.INT_ANO = DATEPART ( year, GETDATE())
            )
            WHEN 0 THEN 'Não'
            ELSE 'Sim' END
        ) AS CHR_PAGO,
        TBL_HOSPEDE_PERMANENTE.INT_DIA_VENCIMENTO
    FROM
        TBL_HOSPEDE_PERMANENTE
    WHERE
        TBL_HOSPEDE_PERMANENTE.BLN_ATIVO = 1
    ORDER BY
        TBL_HOSPEDE_PERMANENTE.CHR_NOME    
END

------------------------------------------------------------------------
-- PROCEDURE LOAD_LIST_HOSPEDE_PERMANENTE_PAGAMENTO_HISTORICO_HOSPEDE --
------------------------------------------------------------------------

CREATE PROCEDURE LOAD_LIST_HOSPEDE_PERMANENTE_PAGAMENTO_HISTORICO_HOSPEDE
(
    @P_COD_HOSPEDE_PERMANENTE INT
)
AS
BEGIN
    IF
    (
        SELECT
            TBL_HOSPEDE_PERMANENTE.BLN_ATIVO
        FROM
            TBL_HOSPEDE_PERMANENTE
        WHERE
            TBL_HOSPEDE_PERMANENTE.COD_HOSPEDE_PERMANENTE = @P_COD_HOSPEDE_PERMANENTE
    ) = 1
    BEGIN
        SELECT
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.COD_HOSPEDE_PERMANENTE_PAGAMENTO,
            CONVERT(VARCHAR(10), ISNULL(TBL_HOSPEDE_PERMANENTE.DT_DATA_INGRESSO, GETDATE()), 112) AS DT_DATA_INGRESSO,
            CONVERT(VARCHAR(10), (GETDATE()), 112) AS DT_DATA_SAIDA,            
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.INT_ANO,
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.INT_MES,
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.FLT_VALOR,
            CONVERT(VARCHAR(10), TBL_HOSPEDE_PERMANENTE_PAGAMENTO.DT_DATA_PAGAMENTO, 103) AS DT_DATA_PAGAMENTO,
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.CHR_OBSERVACAO,
            TBL_HOSPEDE_PERMANENTE.BLN_ATIVO
        FROM
            TBL_HOSPEDE_PERMANENTE
            LEFT JOIN TBL_HOSPEDE_PERMANENTE_PAGAMENTO
                ON TBL_HOSPEDE_PERMANENTE.COD_HOSPEDE_PERMANENTE = TBL_HOSPEDE_PERMANENTE_PAGAMENTO.COD_HOSPEDE_PERMANENTE
        WHERE
            TBL_HOSPEDE_PERMANENTE.COD_HOSPEDE_PERMANENTE = @P_COD_HOSPEDE_PERMANENTE
        ORDER BY
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.INT_ANO,
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.INT_MES
    END
    ELSE
    BEGIN
        SELECT
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.COD_HOSPEDE_PERMANENTE_PAGAMENTO,
            CONVERT(VARCHAR(10), ISNULL(TBL_HOSPEDE_PERMANENTE.DT_DATA_INGRESSO, GETDATE()), 112) AS DT_DATA_INGRESSO,
            CONVERT(VARCHAR(10), ISNULL(TBL_HOSPEDE_PERMANENTE.DT_DATA_SAIDA, GETDATE()), 112) AS DT_DATA_SAIDA,
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.INT_ANO,
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.INT_MES,
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.FLT_VALOR,
            CONVERT(VARCHAR(10), TBL_HOSPEDE_PERMANENTE_PAGAMENTO.DT_DATA_PAGAMENTO, 103) AS DT_DATA_PAGAMENTO,
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.CHR_OBSERVACAO,
            TBL_HOSPEDE_PERMANENTE.BLN_ATIVO
        FROM
            TBL_HOSPEDE_PERMANENTE
            LEFT JOIN TBL_HOSPEDE_PERMANENTE_PAGAMENTO
                ON TBL_HOSPEDE_PERMANENTE.COD_HOSPEDE_PERMANENTE = TBL_HOSPEDE_PERMANENTE_PAGAMENTO.COD_HOSPEDE_PERMANENTE
        WHERE
            TBL_HOSPEDE_PERMANENTE.COD_HOSPEDE_PERMANENTE = @P_COD_HOSPEDE_PERMANENTE
        ORDER BY
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.INT_ANO,
            TBL_HOSPEDE_PERMANENTE_PAGAMENTO.INT_MES
    END
END

---------------------------------------------------
-- PROCEDURE DELETE_HOSPEDE_PERMANENTE_PAGAMENTO --
---------------------------------------------------

CREATE PROCEDURE DELETE_HOSPEDE_PERMANENTE_PAGAMENTO
(
    @P_COD_HOSPEDE_PERMANENTE_PAGAMENTO INT
)
AS
BEGIN
    DELETE
        TBL_HOSPEDE_PERMANENTE_PAGAMENTO
    WHERE
        TBL_HOSPEDE_PERMANENTE_PAGAMENTO.COD_HOSPEDE_PERMANENTE_PAGAMENTO = @P_COD_HOSPEDE_PERMANENTE_PAGAMENTO
END