---------------------------------------
-- INTRANET CELU
-- \App_Data\Procedures\Sistema\Seguranca\TBL_PERMISSAO.SQL
-- # 2010-11-07 - Criação
-- Matheus Araújo
---------------------------------------

-----------------------------------
-- PROCEDURE VERIFICA_PERMISSAO --
-----------------------------------

CREATE PROCEDURE VERIFICA_PERMISSAO
(
	@P_COD_ITEM_PERMISSAO INT,
	@P_CHR_USERNAME VARCHAR(32)
)
AS
BEGIN
	SELECT
		COUNT (*) AS PERMISSAO
	FROM
		TBL_PERMISSAO
		INNER JOIN TBL_MORADOR
			ON TBL_PERMISSAO.COD_PERFIL = TBL_MORADOR.COD_PERFIL		
	WHERE
		TBL_PERMISSAO.COD_ITEM_PERMISSAO = @P_COD_ITEM_PERMISSAO AND
		TBL_MORADOR.CHR_USERNAME = @P_CHR_USERNAME
END

--------------------------------
-- PROCEDURE INSERT_PERMISSAO --
--------------------------------

CREATE PROCEDURE INSERT_PERMISSAO
(
	@P_COD_PERFIL INT,
	@P_CHR_ITEM_PERMISSAO VARCHAR(1024)
)
AS
BEGIN

	-- VARIÁVEIS LOCAIS
	DECLARE @P_COD_ITEM VARCHAR(4)
	DECLARE @P_IND INT
	
	-- DELETA TODAS AS PERMISSÕES DO PROFISSIONAL
	DELETE
		TBL_PERMISSAO
	WHERE
		TBL_PERMISSAO.COD_PERFIL = @P_COD_PERFIL

	-- INICIALIZA ÍNDICE
	SET @P_IND = 1

	-- ENCONTRA PRIMEIRO ITEM
	SET @P_COD_ITEM = SUBSTRING(@P_CHR_ITEM_PERMISSAO, @P_IND, 4)

	-- ENQUANTO ENCONTRAR @P_COD_ITEM
	WHILE @P_COD_ITEM <> ''
	BEGIN

		-- INSERE PERMISSÃO
		INSERT INTO TBL_PERMISSAO
		(
			TBL_PERMISSAO.COD_PERFIL,
			TBL_PERMISSAO.COD_ITEM_PERMISSAO
		)
		VALUES
		(
			@P_COD_PERFIL,
			@P_COD_ITEM
		)
		
		-- INCREMENTA O ÍNDICE
		SET @P_IND = @P_IND + 5

		-- ENCONTRA O PRÓXIMO ITEM
		SET @P_COD_ITEM = SUBSTRING(@P_CHR_ITEM_PERMISSAO, @P_IND, 4)
	END
	
END