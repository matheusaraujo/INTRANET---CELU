---------------------------------------
-- INTRANET CELU
-- \App_Data\Procedures\Diretoria\TBL_MORADOR.SQL
-- # 2010-10-23 - Criação
-- Matheus Araújo
---------------------------------------

------------------------
-- PROCEDURE DO_LOGIN --
------------------------

CREATE PROCEDURE DO_LOGIN
(
	@P_CHR_USERNAME VARCHAR(32),
	@P_CHR_PASSWORD VARCHAR(32)
)
AS
BEGIN

	SELECT
		COUNT(*) AS DO_LOGIN
	FROM
		TBL_MORADOR
	WHERE
		TBL_MORADOR.CHR_USERNAME = @P_CHR_USERNAME AND
		TBL_MORADOR.CHR_PASSWORD = @P_CHR_PASSWORD COLLATE SQL_Latin1_General_Cp1_CS_AS AND
		TBL_MORADOR.BLN_ATIVO = 1	
END


----------------------------------
-- PROCEUDURE LOAD_LIST_MORADOR --
----------------------------------

CREATE PROCEDURE LOAD_LIST_MORADOR
AS
BEGIN
	SELECT
		TBL_MORADOR.COD_MORADOR,
		TBL_MORADOR.CHR_NOME,
		TBL_PERFIL.CHR_DESC_PERFIL
	FROM
		TBL_MORADOR
		LEFT JOIN TBL_PERFIL
		    ON TBL_MORADOR.COD_PERFIL = TBL_PERFIL.COD_PERFIL
	ORDER BY
		TBL_MORADOR.CHR_NOME
END

---------------------------------
-- PROCEUDURE LOAD_REG_MORADOR --
---------------------------------

CREATE PROCEDURE LOAD_REG_MORADOR
(
    @P_COD_MORADOR INT
)
AS
BEGIN
	SELECT
		TBL_MORADOR.COD_MORADOR,
		TBL_MORADOR.BLN_ATIVO,	    
		TBL_MORADOR.CHR_USERNAME,
		TBL_MORADOR.CHR_NOME,
		TBL_MORADOR.CHR_APELIDO,
		TBL_MORADOR.CHR_NUMERO_LAVANDERIA,
		TBL_MORADOR.COD_QUARTO,
		TBL_QUARTO.CHR_DESC_QUARTO,
		TBL_MORADOR.COD_PERFIL,
		TBL_PERFIL.CHR_DESC_PERFIL,
	    TBL_MORADOR.COD_STATUS_MORADOR,
	    TBL_STATUS_MORADOR.CHR_DESC_STATUS_MORADOR,
	    TBL_MORADOR.COD_IES,
	    TBL_IES.CHR_DESC_IES,
	    TBL_MORADOR.COD_CURSO,
	    TBL_CURSO.CHR_DESC_CURSO,
	    TBL_MORADOR.COD_CIDADE_ORIGEM,
	    (
	        TBL_CIDADE.CHR_ESTADO + ' - ' +
	        TBL_CIDADE.CHR_CIDADE
	    ) AS CHR_CIDADE_ORIGEM,
	    CHR_TELEFONE_CELULAR,
	    CHR_EMAIL,
	    CHR_ENDERECO_CONTATO,
	    CHR_TELEFONE_CONTATO,
	    CHR_RG,
	    CHR_CPF,
	    TBL_MORADOR.INT_DIA_ANIVERSARIO,
	    TBL_MORADOR.INT_MES_ANIVERSARIO,
	    (
	        CONVERT(VARCHAR(2), INT_DIA_ANIVERSARIO) + ' de ' +
	        CASE TBL_MORADOR.INT_MES_ANIVERSARIO
	            WHEN 1 THEN 'Janeiro'
	            WHEN 2 THEN 'Fevereiro'
	            WHEN 3 THEN 'Março'
	            WHEN 4 THEN 'Abril'
	            WHEN 5 THEN 'Maio'
	            WHEN 6 THEN 'Junho'
	            WHEN 7 THEN 'Julho'
	            WHEN 8 THEN 'Agosto'
	            WHEN 9 THEN 'Setembro'
	            WHEN 10 THEN 'Outubro'
	            WHEN 11 THEN 'Novembro'
	            WHEN 12 THEN 'Dezembro'
	            ELSE ''
	        END
	    ) AS CHR_ANIVERSARIO,
	    TBL_MORADOR.INT_SEMESTRE_INGRESSO,
	    TBL_MORADOR.INT_ANO_INGRESSO,
	    (
			CONVERT(VARCHAR(2), TBL_MORADOR.INT_SEMESTRE_INGRESSO) + '/' +
			CONVERT(VARCHAR(4), TBL_MORADOR.INT_ANO_INGRESSO)
	    ) AS CHR_INGRESSO
	FROM
		TBL_MORADOR		
		LEFT JOIN TBL_CIDADE
		    ON TBL_MORADOR.COD_CIDADE_ORIGEM = TBL_CIDADE.COD_CIDADE
		LEFT JOIN TBL_QUARTO
		    ON TBL_MORADOR.COD_QUARTO = TBL_QUARTO.COD_QUARTO
		LEFT JOIN TBL_PERFIL
		    ON TBL_MORADOR.COD_PERFIL = TBL_PERFIL.COD_PERFIL
		LEFT JOIN TBL_STATUS_MORADOR
		    ON TBL_MORADOR.COD_STATUS_MORADOR = TBL_STATUS_MORADOR.COD_STATUS_MORADOR
		LEFT JOIN TBL_IES
		    ON TBL_MORADOR.COD_IES = TBL_IES.COD_IES
		LEFT JOIN TBL_CURSO
		    ON TBL_MORADOR.COD_CURSO = TBL_CURSO.COD_CURSO
	WHERE
	    TBL_MORADOR.COD_MORADOR = @P_COD_MORADOR
END

-------------------------------------
-- PROCEDURE VERIFY_INSERT_MORADOR --
-------------------------------------

CREATE PROCEDURE VERIFY_INSERT_MORADOR
(
    @P_COD_MORADOR INT,
	@P_BLN_ATIVO BIT,	    
	@P_CHR_USERNAME VARCHAR(32),	
	@P_CHR_NOME VARCHAR(128),
	@P_CHR_APELIDO VARCHAR(128),
	@P_CHR_NUMERO_LAVANDERIA VARCHAR(4),
	@P_COD_QUARTO INT,
	@P_COD_PERFIL INT,
    @P_COD_STATUS_MORADOR INT,
    @P_COD_IES INT,
    @P_COD_CURSO INT,
    @P_INT_SEMESTRE_INGRESSO INT,
    @P_INT_ANO_INGRESSO INT
)
AS
BEGIN
	DECLARE @P_REFERENCE INT
	
	SET @P_REFERENCE = 
	(
	    SELECT
	        COUNT(*)
	    FROM
	        TBL_MORADOR
	    WHERE
	        TBL_MORADOR.CHR_USERNAME = @P_CHR_USERNAME AND
	        TBL_MORADOR.COD_MORADOR <> @P_COD_MORADOR
	)
	
	IF @P_REFERENCE > 0
	BEGIN
	    SELECT 'O login já foi cadastrado para outro morador!' AS P_CHR_MSG_ERRO
	END
	ELSE
	BEGIN
	
	    SET @P_REFERENCE = 
	    (
	        SELECT
	            COUNT(*)
	        FROM
	            TBL_MORADOR
	        WHERE
	            TBL_MORADOR.CHR_NUMERO_LAVANDERIA = @P_CHR_NUMERO_LAVANDERIA AND
	            TBL_MORADOR.COD_MORADOR <> @P_COD_MORADOR AND
	            TBL_MORADOR.BLN_ATIVO = 1
	    )
	    
	    IF @P_REFERENCE > 0
	    BEGIN
	        SELECT 'O número de lavanderia já foi cadastrado para outro morador!' AS P_CHR_MSG_ERRO
	    END
	    ELSE
	    BEGIN
	        SELECT '' AS P_CHR_MSG_ERRO
	    END
	
	END
	
END

------------------------------
-- PROCEDURE INSERT_MORADOR --
------------------------------

CREATE PROCEDURE INSERT_MORADOR
(
    @P_COD_MORADOR INT,
	@P_BLN_ATIVO BIT,	    
	@P_CHR_USERNAME VARCHAR(32),	
	@P_CHR_NOME VARCHAR(128),
	@P_CHR_APELIDO VARCHAR(128),
	@P_CHR_NUMERO_LAVANDERIA VARCHAR(4),
	@P_COD_QUARTO INT,
	@P_COD_PERFIL INT,
    @P_COD_STATUS_MORADOR INT,
    @P_COD_IES INT,
    @P_COD_CURSO INT,
    @P_INT_SEMESTRE_INGRESSO INT,
    @P_INT_ANO_INGRESSO INT
)
AS
BEGIN

    IF 
    (
        SELECT
            COUNT(*)
        FROM
            TBL_MORADOR
        WHERE
            TBL_MORADOR.COD_MORADOR = @P_COD_MORADOR
    )
    > 0
    BEGIN
        UPDATE
            TBL_MORADOR
        SET
            TBL_MORADOR.BLN_ATIVO = @P_BLN_ATIVO,	    
	        TBL_MORADOR.CHR_USERNAME = @P_CHR_USERNAME,
	        TBL_MORADOR.CHR_NOME = @P_CHR_NOME,
	        TBL_MORADOR.CHR_APELIDO = @P_CHR_APELIDO,
	        TBL_MORADOR.CHR_NUMERO_LAVANDERIA = @P_CHR_NUMERO_LAVANDERIA,
	        TBL_MORADOR.COD_QUARTO = @P_COD_QUARTO,
	        TBL_MORADOR.COD_PERFIL = @P_COD_PERFIL,
            TBL_MORADOR.COD_STATUS_MORADOR = @P_COD_STATUS_MORADOR,
            TBL_MORADOR.COD_IES = @P_COD_IES,
            TBL_MORADOR.COD_CURSO = @P_COD_CURSO,
            TBL_MORADOR.INT_SEMESTRE_INGRESSO = @P_INT_SEMESTRE_INGRESSO,
            TBL_MORADOR.INT_ANO_INGRESSO = @P_INT_ANO_INGRESSO
        WHERE
            TBL_MORADOR.COD_MORADOR = @P_COD_MORADOR
    END
    ELSE
    BEGIN
        INSERT INTO TBL_MORADOR
        (
            TBL_MORADOR.BLN_ATIVO,	    
	        TBL_MORADOR.CHR_USERNAME,
	        TBL_MORADOR.CHR_PASSWORD,
	        TBL_MORADOR.CHR_NOME,
	        TBL_MORADOR.CHR_APELIDO,
	        TBL_MORADOR.CHR_NUMERO_LAVANDERIA,
	        TBL_MORADOR.COD_QUARTO,
	        TBL_MORADOR.COD_PERFIL,
            TBL_MORADOR.COD_STATUS_MORADOR,
            TBL_MORADOR.COD_IES,
            TBL_MORADOR.COD_CURSO,
            TBL_MORADOR.INT_SEMESTRE_INGRESSO,
            TBL_MORADOR.INT_ANO_INGRESSO
        )
        VALUES
        (
            @P_BLN_ATIVO,	    
	        @P_CHR_USERNAME,
	        '123456',
	        @P_CHR_NOME,
	        @P_CHR_APELIDO,
	        @P_CHR_NUMERO_LAVANDERIA,
	        @P_COD_QUARTO,
	        @P_COD_PERFIL,
            @P_COD_STATUS_MORADOR,
            @P_COD_IES,
            @P_COD_CURSO,
            @P_INT_SEMESTRE_INGRESSO,
            @P_INT_ANO_INGRESSO
        )
    END
END

--------------------------------------
-- PROCEDURE INSERT_MORADOR_PESSOAL --
--------------------------------------

CREATE PROCEDURE INSERT_MORADOR_PESSOAL
(
    @P_COD_MORADOR INT,
    @P_CHR_APELIDO VARCHAR(128),
    @P_COD_CIDADE_ORIGEM INT, 
    @P_CHR_TELEFONE_CELULAR VARCHAR(16),
    @P_CHR_EMAIL VARCHAR(64),
    @P_CHR_ENDERECO_CONTATO VARCHAR(1024),
    @P_CHR_TELEFONE_CONTATO VARCHAR(16), 
    @P_CHR_RG VARCHAR(16), 
    @P_CHR_CPF VARCHAR(16),
    @P_INT_DIA_ANIVERSARIO INT,
    @P_INT_MES_ANIVERSARIO INT,
    @P_INT_SEMESTRE_INGRESSO INT,
    @P_INT_ANO_INGRESSO INT
)
AS
BEGIN
    UPDATE
        TBL_MORADOR
    SET
		TBL_MORADOR.CHR_APELIDO = @P_CHR_APELIDO,
        TBL_MORADOR.COD_CIDADE_ORIGEM = @P_COD_CIDADE_ORIGEM,
        TBL_MORADOR.CHR_TELEFONE_CELULAR = @P_CHR_TELEFONE_CELULAR,
        TBL_MORADOR.CHR_EMAIL = @P_CHR_EMAIL,
        TBL_MORADOR.CHR_ENDERECO_CONTATO = @P_CHR_ENDERECO_CONTATO,
        TBL_MORADOR.CHR_TELEFONE_CONTATO = @P_CHR_TELEFONE_CONTATO,
        TBL_MORADOR.CHR_RG = @P_CHR_RG,
        TBL_MORADOR.CHR_CPF = @P_CHR_CPF,
        TBL_MORADOR.INT_DIA_ANIVERSARIO = @P_INT_DIA_ANIVERSARIO,
        TBL_MORADOR.INT_MES_ANIVERSARIO = @P_INT_MES_ANIVERSARIO,
        TBL_MORADOR.INT_SEMESTRE_INGRESSO = @P_INT_SEMESTRE_INGRESSO,
        TBL_MORADOR.INT_ANO_INGRESSO = @P_INT_ANO_INGRESSO
    WHERE
        TBL_MORADOR.COD_MORADOR = @P_COD_MORADOR    
END

------------------------------
-- PROCEDURE DELETE_MORADOR --
------------------------------

CREATE PROCEDURE DELETE_MORADOR
(
    @P_COD_MORADOR INT
)
AS
BEGIN
    
    IF
    (
		SELECT
			COUNT(*)
		FROM
			TBL_AVISO
		WHERE
			TBL_AVISO.COD_MORADOR = @P_COD_MORADOR
    )
    > 0
    BEGIN
		SELECT 'O morador possui avisos no Sistema!' AS P_CHR_MSG_ERRO
    END
    ELSE
    BEGIN
		SELECT '' AS P_CHR_MSG_ERRO
		DELETE
			TBL_MORADOR    
		WHERE
			TBL_MORADOR.COD_MORADOR = @P_COD_MORADOR
    END
      
END

-----------------------------------------
-- PROCECURE LOAD_MORADOR_COD_BY_LOGIN --
-----------------------------------------

CREATE PROCEDURE LOAD_MORADOR_COD_BY_LOGIN
(
    @P_CHR_USERNAME VARCHAR(32)
)
AS
BEGIN
    SELECT
        TBL_MORADOR.COD_MORADOR
    FROM
        TBL_MORADOR
    WHERE
        TBL_MORADOR.CHR_USERNAME = @P_CHR_USERNAME
END

-----------------------------------
-- PROCEDURE MORADOR_CHANGE_PASS --
-----------------------------------

CREATE PROCEDURE MORADOR_CHANGE_PASS
(
    @P_COD_MORADOR INT,
    @P_CHR_PASSWORD VARCHAR(32)
)
AS
BEGIN
    UPDATE
        TBL_MORADOR
    SET
        TBL_MORADOR.CHR_PASSWORD = @P_CHR_PASSWORD
    WHERE
        TBL_MORADOR.COD_MORADOR = @P_COD_MORADOR
END

-----------------------------------------
-- PROCEDURE LOAD_LIST_ANIVERSARIO_MES --
-----------------------------------------

CREATE PROCEDURE LOAD_LIST_ANIVERSARIO_MES
AS
BEGIN
    SELECT
		TBL_MORADOR.COD_MORADOR,
        TBL_MORADOR.CHR_NOME,
        (
	        CONVERT(VARCHAR(2), INT_DIA_ANIVERSARIO) + ' de ' +
	        CASE TBL_MORADOR.INT_MES_ANIVERSARIO
	            WHEN 1 THEN 'Janeiro'
	            WHEN 2 THEN 'Fevereiro'
	            WHEN 3 THEN 'Março'
	            WHEN 4 THEN 'Abril'
	            WHEN 5 THEN 'Maio'
	            WHEN 6 THEN 'Junho'
	            WHEN 7 THEN 'Julho'
	            WHEN 8 THEN 'Agosto'
	            WHEN 9 THEN 'Setembro'
	            WHEN 10 THEN 'Outubro'
	            WHEN 11 THEN 'Novembro'
	            WHEN 12 THEN 'Dezembro'
	            ELSE ''
	        END
	    ) AS CHR_ANIVERSARIO
	FROM
	    TBL_MORADOR
	WHERE
	    TBL_MORADOR.INT_MES_ANIVERSARIO = CONVERT(INT, DATEPART(MONTH, GETDATE()))
	ORDER BY
	    TBL_MORADOR.INT_DIA_ANIVERSARIO,
	    TBL_MORADOR.CHR_NOME
END

------------------------------
-- PROCEDURE RESET_PASSWORD --
------------------------------

CREATE PROCEDURE RESET_PASSWORD
(
	@P_COD_MORADOR INT	
)
AS
BEGIN
	UPDATE
		TBL_MORADOR
	SET
		TBL_MORADOR.CHR_PASSWORD = '123456'
	WHERE
		TBL_MORADOR.COD_MORADOR = @P_COD_MORADOR
END