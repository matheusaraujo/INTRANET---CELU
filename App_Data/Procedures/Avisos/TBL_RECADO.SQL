---------------------------------------
-- INTRANET CELU
-- \App_Data\Procedures\Aviso\TBL_RECADO.SQL
-- # 2011-04-09 - Criação
-- Matheus Araújo
---------------------------------------

-----------------------------
-- PROCEDURE INSERT_RECADO --
-----------------------------

CREATE PROCEDURE INSERT_RECADO
(
	@P_COD_MORADOR INT,
	@P_COD_TIPO_RECADO INT,
	@P_CHR_RECADO VARCHAR(2048)
)
AS
BEGIN

	INSERT INTO TBL_RECADO
	(
		TBL_RECADO.COD_MORADOR,
		TBL_RECADO.COD_TIPO_RECADO,
		TBL_RECADO.DT_DATAHORA,
		TBL_RECADO.BLN_OCULTO,
		TBL_RECADO.CHR_RECADO
	)
	VALUES
	(
		@P_COD_MORADOR,
		@P_COD_TIPO_RECADO,
		GETDATE(),
		0,
		@P_CHR_RECADO
	)

END

--------------------------------------
-- PROCEDURE LOAD_LIST_MEUS_RECADOS --
--------------------------------------

CREATE PROCEDURE LOAD_LIST_MEUS_RECADOS
(
	@P_COD_MORADOR INT
)
AS
BEGIN
	SELECT
		TBL_RECADO.COD_RECADO,
		TBL_TIPO_RECADO.CHR_DESC_TIPO_RECADO,
		(
            CONVERT(VARCHAR(10), TBL_RECADO.DT_DATAHORA, 103) + ' - ' +
            CONVERT(VARCHAR(5), TBL_RECADO.DT_DATAHORA, 108)
        ) AS DT_DATAHORA
    FROM
		TBL_RECADO
		INNER JOIN TBL_TIPO_RECADO
			ON TBL_RECADO.COD_TIPO_RECADO = TBL_TIPO_RECADO.COD_TIPO_RECADO
	WHERE
		TBL_RECADO.COD_MORADOR = @P_COD_MORADOR
	ORDER BY
		TBL_RECADO.DT_DATAHORA DESC
END

-------------------------------
-- PROCEDURE LOAD_REG_RECADO --
-------------------------------

CREATE PROCEDURE LOAD_REG_RECADO
(
	@P_COD_RECADO INT
)
AS
BEGIN

	SELECT
		TBL_MORADOR.CHR_NOME,
		(
            CONVERT(VARCHAR(10), TBL_RECADO.DT_DATAHORA, 103) + ' - ' +
            CONVERT(VARCHAR(5), TBL_RECADO.DT_DATAHORA, 108)
        ) AS DT_DATAHORA,
        TBL_TIPO_RECADO.CHR_DESC_TIPO_RECADO,
        TBL_RECADO.CHR_RECADO
    FROM
		TBL_RECADO
		INNER JOIN TBL_MORADOR
			ON TBL_RECADO.COD_MORADOR = TBL_MORADOR.COD_MORADOR
		INNER JOIN TBL_TIPO_RECADO
			ON TBL_RECADO.COD_TIPO_RECADO = TBL_TIPO_RECADO.COD_TIPO_RECADO
	WHERE
		TBL_RECADO.COD_RECADO = @P_COD_RECADO
END

---------------------------------
-- PROCEDURE LOAD_LIST_RECADOS --
---------------------------------

CREATE PROCEDURE LOAD_LIST_RECADOS
(
	@P_COD_MORADOR INT,
	@P_BLN_MOSTRA_OCULTO BIT
)
AS
BEGIN
	SELECT
		TBL_RECADO.COD_RECADO,
		TBL_MORADOR.CHR_NOME,
		TBL_TIPO_RECADO.CHR_DESC_TIPO_RECADO,
		(
            CONVERT(VARCHAR(10), TBL_RECADO.DT_DATAHORA, 103) + ' - ' +
            CONVERT(VARCHAR(5), TBL_RECADO.DT_DATAHORA, 108)
        ) AS DT_DATAHORA,
        TBL_RECADO.BLN_OCULTO
    FROM
		TBL_RECADO
		INNER JOIN TBL_TIPO_RECADO
			ON TBL_RECADO.COD_TIPO_RECADO = TBL_TIPO_RECADO.COD_TIPO_RECADO
		INNER JOIN TBL_MORADOR
			ON TBL_RECADO.COD_MORADOR = TBL_MORADOR.COD_MORADOR
	WHERE
		TBL_RECADO.COD_TIPO_RECADO IN
		(
			SELECT
				TBL_PERMISSAO_TIPO_RECADO.COD_TIPO_RECADO
			FROM
				TBL_PERMISSAO_TIPO_RECADO
			WHERE
				TBL_PERMISSAO_TIPO_RECADO.COD_PERFIL =
				(
					SELECT
						TBL_MORADOR.COD_PERFIL
					FROM
						TBL_MORADOR
					WHERE
						TBL_MORADOR.COD_MORADOR = @P_COD_MORADOR
				)
		) AND
		(TBL_RECADO.BLN_OCULTO = 0 OR @P_BLN_MOSTRA_OCULTO = 1)
	ORDER BY
		TBL_RECADO.DT_DATAHORA DESC
		
END

-----------------------------------
-- PROCEDURE EXIBE_OCULTA_RECADO --
-----------------------------------

CREATE PROCEDURE EXIBE_OCULTA_RECADO
(
	@P_COD_RECADO INT
)
AS
BEGIN
	UPDATE
		TBL_RECADO
	SET		
		TBL_RECADO.BLN_OCULTO = 
		(CASE TBL_RECADO.BLN_OCULTO
			WHEN 1 THEN 0
			ELSE 1
		END)
	WHERE
		TBL_RECADO.COD_RECADO = @P_COD_RECADO
END
