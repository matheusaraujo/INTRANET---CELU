---------------------------------------
-- INTRANET CELU
-- \App_Data\Procedures\Aviso\TBL_PERMISSAO_TIPO_RECADO.SQL
-- # 2011-04-09 - Criação
-- Matheus Araújo
---------------------------------------

--------------------------------------------
-- PROCEDURE LOAD_LIST_PERFIL_TIPO_RECADO --
--------------------------------------------

CREATE PROCEDURE LOAD_LIST_PERFIL_TIPO_RECADO
(
    @P_COD_TIPO_RECADO INT
)
AS
BEGIN
    SELECT
        TBL_PERFIL.COD_PERFIL,
        TBL_PERFIL.CHR_DESC_PERFIL,
		(
			SELECT
				COUNT(*)
			FROM
				TBL_PERMISSAO_TIPO_RECADO
			WHERE
				TBL_PERMISSAO_TIPO_RECADO.COD_PERFIL = TBL_PERFIL.COD_PERFIL AND
				TBL_PERMISSAO_TIPO_RECADO.COD_TIPO_RECADO = @P_COD_TIPO_RECADO
		) AS PERMISSAO        
    FROM
        TBL_PERFIL        
    ORDER BY
        TBL_PERFIL.CHR_DESC_PERFIL
END

--------------------------------------------
-- PROCEDURE INSERT_PERMISSAO_TIPO_RECADO --
--------------------------------------------

CREATE PROCEDURE INSERT_PERMISSAO_TIPO_RECADO
(
	@P_COD_TIPO_RECADO INT,
	@P_CHR_PERFIL VARCHAR(1024)
)
AS
BEGIN

	-- VARIÁVEIS LOCAIS
	DECLARE @P_COD_ITEM VARCHAR(4)
	DECLARE @P_IND INT
	
	-- DELETA TODAS AS PERMISSÕES DO PROFISSIONAL
	DELETE
		TBL_PERMISSAO_TIPO_RECADO
	WHERE
		TBL_PERMISSAO_TIPO_RECADO.COD_TIPO_RECADO = @P_COD_TIPO_RECADO

	-- INICIALIZA ÍNDICE
	SET @P_IND = 1

	-- ENCONTRA PRIMEIRO ITEM
	SET @P_COD_ITEM = SUBSTRING(@P_CHR_PERFIL, @P_IND, 4)

	-- ENQUANTO ENCONTRAR @P_COD_ITEM
	WHILE @P_COD_ITEM <> ''
	BEGIN

		-- INSERE PERMISSÃO
		INSERT INTO TBL_PERMISSAO_TIPO_RECADO
		(
			TBL_PERMISSAO_TIPO_RECADO.COD_TIPO_RECADO,
			TBL_PERMISSAO_TIPO_RECADO.COD_PERFIL
		)
		VALUES
		(
			@P_COD_TIPO_RECADO,
			@P_COD_ITEM
		)
		
		-- INCREMENTA O ÍNDICE
		SET @P_IND = @P_IND + 5

		-- ENCONTRA O PRÓXIMO ITEM
		SET @P_COD_ITEM = SUBSTRING(@P_CHR_PERFIL, @P_IND, 4)
	END
	
END

-----------------------------------------------
-- PROCEDURE LOAD_LIST_PERFIL_BY_TIPO_RECADO --
-----------------------------------------------

CREATE PROCEDURE LOAD_LIST_PERFIL_BY_TIPO_RECADO
(
	@P_COD_TIPO_RECADO INT
)
AS
BEGIN
	SELECT
		TBL_PERFIL.CHR_DESC_PERFIL
	FROM
		TBL_PERFIL
		INNER JOIN TBL_PERMISSAO_TIPO_RECADO
			ON TBL_PERFIL.COD_PERFIL = TBL_PERMISSAO_TIPO_RECADO.COD_PERFIL
	WHERE
		TBL_PERMISSAO_TIPO_RECADO.COD_TIPO_RECADO = @P_COD_TIPO_RECADO
	ORDER BY
		TBL_PERFIL.CHR_DESC_PERFIL		
END